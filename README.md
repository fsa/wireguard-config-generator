# wireguard-config-generator

Это скрипты для автоматической генерации конфигурации для Wireguard, работающем в режиме звезда. В качестве основы был взят скрипт [nebulakl/wireguard-config-generator](https://github.com/nebulakl/wireguard-config-generator).

Для начала работы необходимо создать файл `.env`. Можно взять за основу файл `.env.example`. Обязательные параметры `PUBLIC_NETWORK_INTERFACE` (публичный интерфейс вашего сервера) и `WG_SERVER_ADDRESS` (адрес вашего сервера). Остальные параметры не являются обязательными и могут быть использованы по мере необходимости.

## Создание конфигурации Wireguard для сервера VPN

Для формирования конфигурации вашего VPN сервера запустите `./wireguard-server-gen.sh`. При этом будет создана директория `wgconfigs` с файлами конфигурации и служебными файлами:

* файл wg0.conf, где wg0 - имя вашего интерфейса Wireguard;
* .env - файл с настройками, необходимый для генерации клиентских конфигураций;
* client_ip_suffix.txt - файл с текущим префиксом IPv4 (последний разряд адреса).

Если префикс IPv4 не был указан, то будет сгенерирован случайных префикс `10.x.y.`.

Если префикс IPv6 не был указан, то будет сгенерирован случайный префикс `fd00:xxxx:yyyy:zzzz:`.

## Создание конфигурации клиентов VPN

После формирования серверной конфигурации можно создать до 253 конфигураций клиентов. При попытке создать большее число конфигураций, у новых клиентов будет неверно задан IPv4 адрес, т.к. он превысит значение 254. Количество конфигураций IPv6 адресов не ограничено в разумных пределах, но требует ручного удаления из конфигурации неверного IPv4 адреса. А этом случае клиент не будет иметь возможность использовать IPv4 адресацию внутри VPN соединения.

Для создания новой конфигурации VPN клиента запустите `./wireguard-client-gen.sh`. Скрипт использует ранее сформированные настройки из `wgconfigs/.env`. Новая конфигурация клиента будет размещена в директории `wgconfigs/clientconfigs/` в файл с именем `wg0cX.conf`, где wg0 - имя интерфейса Wireguard на сервере VPN (wg0 по умолчанию), X - номер клиента, начиная с 2 (соответствует последнему разряду IPv4 адреса).

При каждом запуске скрипта формируется одна новая конфигурация.

После формирования конфигурации клиента, в конфигурацию сервера вносится дополнительная запись `[Peer]`! Перед подключением клиента требуется, чтобы файл конфигурации сервера был прочитан заново, например, путём перезапуска Wireguard на сервере.

## Известные проблемы

* При создании более 253 конфигураций будет неверно формироваться IPv4 адрес для клиента.
* Маловероятны, но теоретически возможны конфликты IPv6 адресов.
