# wireguard-config-generator

Это скрипты для автоматической генерации конфигурации для Wireguard, работающем в режиме звезда. В качестве основы был взят скрипт [nebulakl/wireguard-config-generator](https://github.com/nebulakl/wireguard-config-generator).

Для начала работы необходимо создать файл `.env`. Можно взять за основу файл `.env.example`. Обязательные параметры `PUBLIC_NETWORK_INTERFACE` (публичный интерфейс вашего сервера) и `WG_SERVER_ADDRESS` (адрес вашего сервера). Остальные параметры не являются обязательными и могут быть использованы по мере необходимости.

## Создание конфигурации Wireguard для сервера VPN

Для формирования конфигурации вашего VPN сервера запустите `./wireguard-server-gen.sh`. При этом будет создана директория `wgconfigs` с файлами конфигурации и служебными файлами:

* файл wg0.conf, где wg0 - имя вашего интерфейса Wireguard;
* .env - файл с настройками, необходимый для генерации клиентских конфигураций;
* client_ip_suffix.txt - файл с текущим префиксом IPv4 (последний разряд адреса).

Если префикс IPv4 не был указан, то будет сгенерирован случайных префикс `10.x.y.`.

Если префикс IPv6 не был указан, то будет сгенерирован случайный префикс `fd00:xxxx:yyyy:zzzz:`. Использовать его **не рекомендуется**. Укажите свой префикс для ULA в `.env` в параметре `WG_IPV6_PREFIX`. Если ваш провайдер ограничил вас сетью `/64`, то можете использовать сеть `/65`, что также **не рекомендуется**, но может быть использовано в качестве варианта для обхода ограничения провайдера.

Оптимальным вариантом является выделение вашим провайдером отдельной сети, которая будет делегирована на ваш сервер. Если же провайдер не выделил вам отельной сети, которая маршутизируется через ваш сервер (прописан маршрут на маршрутизаторе провайдера до вашей машины для этой сети), то необходимо использовать NDP proxy. В этом случае провайдер считает, что адрес должен быть прописан на вашем сервере. Чтобы адрес начал работать, необходимо отвечать на запросы провайдера по обнаружению соседей. Для этого можно установить ndppd и использовать конфигурацию следующего вида:

```console
proxy ens3 {
    rule 2001:0db8:827:fcde:cafb:073d:a65e:25b0 {
        static
    }
}
```

ens3 - это сетевой интерфейс сервера. В rule указываете необходимый адрес клиента. Правила rule необходимо прописать для каждого используемого клиентами адреса. В данном случае сервер будет отвечать, что этот адрес находится у него и трафик будет перенаправлен на VPS маршрутизатором провайдера.

По умолчанию для IPv6 используется стандартная длина префикса. Но на многих хостингах на виртуальную машину выделяется только сеть размером `/64`, которая не позволит выделить IP адрес для клиентов. Для этого в скрипте можно указать параметр `WG_IPV6_PREFIX_LEN=65`. В этом случае для Wireguard будет использована адресация `/65`. Это требует также настройки сетевой карты на VPS. Там также необходимо указать длину префикса `/65` вместо `/64`. Младшая часть диапазона `/64` будет использована для адресов на VPS, старшая - для адресации клиентов VPS (`::8000:0:0:0` и старше).

Параметр `WG_IPV6_NAT=true` включит трансляцию адресов (NAT) путём добавления дополнительных строк в файл конфигурации сервера. Этот режим необходим, если используется адресация `fc00::/7` (используется по умолчанию если не указан префикс IPv6 в файле конфигурации). Данный режим **не рекомендуется** ввиду того, то будут использована локальная адресация на клиентах, что может привести к предпочтению IPv4 вместо IPv6.

## Создание конфигурации клиентов VPN

После формирования серверной конфигурации можно создать до 253 конфигураций клиентов. При попытке создать большее число конфигураций, у новых клиентов будет неверно задан IPv4 адрес, т.к. он превысит значение 254. Количество конфигураций IPv6 адресов не ограничено в разумных пределах, но требует ручного удаления из конфигурации неверного IPv4 адреса. А этом случае клиент не будет иметь возможность использовать IPv4 адресацию внутри VPN соединения.

Для создания новой конфигурации VPN клиента запустите `./wireguard-client-gen.sh`. Скрипт использует ранее сформированные настройки из `wgconfigs/.env`. Новая конфигурация клиента будет размещена в директории `wgconfigs/clientconfigs/` в файл с именем `wg0cX.conf`, где wg0 - имя интерфейса Wireguard на сервере VPN (wg0 по умолчанию), X - номер клиента, начиная с 2 (соответствует последнему разряду IPv4 адреса).

При каждом запуске скрипта формируется одна новая конфигурация.

После формирования конфигурации клиента, в конфигурацию сервера вносится дополнительная запись `[Peer]`! Перед подключением клиента требуется, чтобы файл конфигурации сервера был прочитан заново, например, путём перезапуска Wireguard на сервере.

## Известные проблемы

* При создании более 253 конфигураций будет неверно формироваться IPv4 адрес для клиента.
* Маловероятны, но теоретически возможны конфликты IPv6 адресов.
